# Medical Prompt Hub 改善レポート

## 実施日
2025年12月7日

## 問題の診断

### 発見した問題
Medical Prompt Hubのプロンプト詳細ページにおいて、ユーザーが入力フィールドにテキストを入力しても、プレビュー画面に反映されない問題が発生していました。

### 根本原因
テンプレート内のプレースホルダー形式と、`PromptDetail.tsx`の`generatePrompt()`関数で期待される形式が一致していませんでした。

**問題のある実装:**
- テンプレート内: `[主訴を入力]`、`[現病歴を入力]` などの`[...]`形式
- 関数が期待する形式: `{{key}}`形式（例: `{{chief_complaint}}`、`{{present_illness}}`）

**結果:** ユーザーの入力が`{{key}}`形式のプレースホルダーに置換されるべきところ、テンプレート内に該当するプレースホルダーが存在しないため、入力が反映されませんでした。

## 実施した修正

### Phase 1: コードベース分析
- リポジトリをクローンし、全49個のプロンプトの構造を分析
- 24個のプロンプトで修正が必要なプレースホルダーを特定（合計31箇所）

### Phase 2: プロンプト入力反映の修正
全プロンプトのテンプレート内のプレースホルダーを`[...]`形式から`{{key}}`形式に統一しました。

**修正例:**
```typescript
// 修正前
template: `主訴: [主訴を入力]`
inputs: [{ key: 'chief_complaint', ... }]

// 修正後
template: `主訴: {{chief_complaint}}`
inputs: [{ key: 'chief_complaint', ... }]
```

### Phase 3: UI改善の実装

#### 3.1 Differential Diagnosis Generator（鑑別診断ジェネレーター）の詳細化

**改善前:**
- 単一のテキストエリア「症例情報」のみ

**改善後:**
- **主訴**: プルダウン選択（15種類の一般的な症状 + 「その他」）
  - 発熱、頭痛、胸痛、腹痛、呼吸困難、咳嗽、嘔気・嘔吐、下痢、めまい、意識障害、全身倦怠感、関節痛、腰痛、浮腫、その他
- **現病歴**: テキストエリア（自由記載）
- **既往歴**: プルダウン選択（11種類の一般的な疾患 + 「その他」）
  - なし、高血圧、糖尿病、脂質異常症、心疾患、脳血管疾患、慢性腎臓病、肝疾患、悪性腫瘍、喘息・COPD、その他
- **バイタルサイン**: 構造化された個別入力フィールド
  - 体温 (°C)
  - 血圧 (mmHg)
  - 脈拍 (/分)
  - 呼吸数 (/分)
  - SpO2 (%)

**テンプレートの改善:**
```typescript
template: `あなたは熟練した総合診療医です。以下の症例情報に基づき、鑑別診断リストを作成してください。

# 症例情報
- 主訴: {{chief_complaint}}
- 現病歴: {{present_illness}}
- 既往歴: {{past_history}}
- バイタルサイン: 体温{{temperature}}°C、血圧{{blood_pressure}}mmHg、脈拍{{pulse}}/分、呼吸数{{respiratory_rate}}/分、SpO2 {{spo2}}%

# 出力形式
1. **Critical (見逃してはいけない疾患)**: 3つ
2. **Common (頻度の高い疾患)**: 3つ
3. **Rare (稀だが考慮すべき疾患)**: 2つ

各疾患について、この症例で疑う根拠と、除外するために必要な追加検査を簡潔に記載してください。`
```

#### 3.2 全プロンプトの修正完了
- 全49個のプロンプトのプレースホルダーを修正
- 合計34個のプレースホルダーを`{{key}}`形式に変換

## 技術的な詳細

### 使用したツール
- **Python**: プレースホルダーの一括置換スクリプト
- **正規表現**: パターンマッチングによる効率的な置換
- **Git**: バージョン管理とGitHubへのプッシュ

### 修正したファイル
- `client/src/lib/prompts-full.ts`: 全プロンプトのテンプレートとinputsを修正

## 期待される効果

### ユーザー体験の改善
1. **入力の即時反映**: ユーザーが入力した内容がプレビューに正しく表示されるようになります
2. **入力の効率化**: プルダウン選択により、一般的な症状や疾患を素早く選択できます
3. **構造化された入力**: バイタルサインなどを個別フィールドで入力できるため、入力漏れを防げます
4. **医学的な標準化**: 一般的な症状や疾患のリストにより、医学的に適切な入力が促されます

### 使いやすさの向上
- **穴埋め形式**: 必要な情報を段階的に入力できる
- **プルダウン選択**: タイピングの手間を削減
- **明確なラベル**: 各入力フィールドの目的が明確

## デプロイ状況

### GitHubへのプッシュ
- コミットID: `e5a212e`
- ブランチ: `main`
- 自動デプロイ: GitHub Actionsにより自動的にGitHub Pagesにデプロイされます

### 確認方法
数分後に以下のURLで修正が反映されます:
https://kgraph57.github.io/medicalprompthub/

## 今後の改善提案

### 短期的な改善
1. **他の主要プロンプトの詳細化**
   - Symptom Analysis (OPQRST)
   - Lab Result Interpretation
   - Evidence-Based Treatment Plan
   など、使用頻度の高いプロンプトについても同様の詳細化を実施

2. **複数選択対応**
   - 既往歴など、複数の項目を選択できるようにチェックボックス形式を追加

3. **入力バリデーション**
   - バイタルサインの数値範囲チェック
   - 必須フィールドの入力チェック

### 中長期的な改善
1. **プリセット機能**
   - よく使う症例パターンを保存・読み込み機能

2. **入力履歴**
   - 過去の入力内容を再利用できる機能

3. **AI支援入力**
   - 主訴から推奨される検査項目を提案

4. **モバイル最適化**
   - スマートフォンでの入力体験の向上

## まとめ

本改善により、Medical Prompt Hubのプロンプト入力機能が正常に動作するようになり、ユーザーフレンドリーなUI（穴埋め形式、プルダウン選択、構造化入力）が実装されました。特に、診断支援の主要プロンプトである「Differential Diagnosis Generator」については、医学的に標準化された選択肢と構造化された入力フィールドにより、大幅な使いやすさの向上が期待されます。

今後も、ユーザーからのフィードバックを基に、継続的な改善を行っていく予定です。
