# Helix サービスリリース実装計画

## 📋 プロジェクト概要

**Helix** は医療従事者向けAIプロンプトライブラリプラットフォームです。
- 100以上の医療特化プロンプト
- 10以上のカテゴリ（診断支援、文書作成、研究、教育等）
- ワークフローガイド（症例報告、MARW、統計分析）
- 41のAIリテラシー/テクニックTips
- インタラクティブな学習コース

## 🎯 現状分析

### ✅ 実装済み（80%完了）
- レスポンシブデザイン＆モバイル最適化
- エラーハンドリング＆リカバリー機構
- セキュリティヘッダー＆認証フレームワーク
- GA4アナリティクス＆Sentry監視
- SEO最適化（メタタグ、JSON-LD、OGP）
- アクセシビリティ機能
- CI/CDパイプライン（GitHub Actions）
- パフォーマンス最適化（コード分割、圧縮）
- データベーススキーマ（Drizzle ORM）
- レート制限＆セキュリティミドルウェア

### ⚠️ 要改善
| 項目 | 現状 | 目標 |
|------|------|------|
| テストカバレッジ | 15-20% | 80%以上 |
| E2Eテスト | なし | Playwright導入 |
| CSPヘッダー | unsafe-inline許可 | 厳格化 |
| ドキュメント | 最小限 | API/デプロイガイド |

### ❌ 未実装（本番に必要）
- 本番用バックエンドデプロイ
- データベースバックアップ戦略
- 集中ログ管理
- アップタイム監視＆アラート
- ステージング環境
- シークレット管理

---

## 📅 実装フェーズ

### Phase 1: テスト強化（優先度: 最高）
**目的**: 品質保証とリグレッション防止

#### 1.1 ユニットテスト拡充
- [ ] コンポーネントテスト追加（54コンポーネント）
  - `client/src/components/` 配下の全コンポーネント
  - 特に重要: `PromptCard`, `SearchBar`, `CategoryFilter`, `FavoriteButton`
- [ ] ユーティリティ関数テスト追加（31モジュール）
  - `client/src/lib/` 配下の全モジュール
  - 特に重要: `prompts-loader.ts`, `analytics.ts`, `seo.ts`
- [ ] カスタムフックテスト追加
  - `client/src/hooks/` 配下の全フック

#### 1.2 統合テスト追加
- [ ] APIエンドポイントテスト
  - `/api/prompts` - プロンプト取得
  - `/api/favorites` - お気に入り操作
  - `/api/auth` - 認証フロー
- [ ] データベース操作テスト
  - Drizzle ORM操作の検証
  - トランザクション処理の検証

#### 1.3 E2Eテスト導入（Playwright）
- [ ] Playwright設定
  ```bash
  npm install -D @playwright/test
  npx playwright install
  ```
- [ ] クリティカルユーザーフロー
  - ホームページ→カテゴリ選択→プロンプト表示→コピー
  - 検索→結果表示→詳細閲覧
  - お気に入り登録/解除
  - ガイド閲覧フロー
  - コース/レッスン完了フロー
- [ ] レスポンシブテスト（モバイル/タブレット/デスクトップ）
- [ ] アクセシビリティテスト（axe-core）

#### 1.4 カバレッジ目標
- ユニットテスト: 80%以上
- 統合テスト: 主要API 100%
- E2Eテスト: クリティカルパス 100%

**成果物**:
- `client/src/**/*.test.tsx` - コンポーネントテスト
- `server/**/*.test.ts` - APIテスト
- `e2e/**/*.spec.ts` - E2Eテスト
- `vitest.config.ts` - カバレッジ設定
- `playwright.config.ts` - E2E設定

---

### Phase 2: セキュリティ強化（優先度: 最高）
**目的**: 本番環境でのセキュリティ確保

#### 2.1 CSPヘッダー厳格化
- [ ] `server/_core/securityHeaders.ts` 修正
  - `'unsafe-inline'` 削除（nonceベースに移行）
  - `'unsafe-eval'` 削除
- [ ] Vite設定でCSP nonce対応
- [ ] スタイル/スクリプトのnonce適用

#### 2.2 シークレット管理
- [ ] 環境変数の整理
  ```
  # 本番必須
  DATABASE_URL=
  JWT_SECRET=
  SENTRY_DSN=
  GA_MEASUREMENT_ID=

  # オプション
  UMAMI_WEBSITE_ID=
  METRICS_TOKEN=
  ```
- [ ] `.env.example` 更新
- [ ] GitHub Secrets設定ガイド作成

#### 2.3 認証強化
- [ ] JWT有効期限設定の見直し
- [ ] リフレッシュトークン実装（必要に応じて）
- [ ] セッション管理の強化

#### 2.4 入力バリデーション監査
- [ ] 全APIエンドポイントのZodスキーマ確認
- [ ] SQLインジェクション対策確認
- [ ] XSS対策確認（現状rehype-sanitize使用）

**成果物**:
- 更新された `securityHeaders.ts`
- `.env.example` 更新版
- セキュリティ監査レポート

---

### Phase 3: インフラストラクチャ構築（優先度: 高）
**目的**: 本番環境の構築と運用基盤の確立

#### 3.1 デプロイ先選定
**推奨オプション**:

| プラットフォーム | フロントエンド | バックエンド | DB | 月額コスト |
|-----------------|---------------|-------------|-----|-----------|
| **Vercel + PlanetScale** | Vercel | Vercel Functions | PlanetScale | 無料〜$20 |
| **Railway** | Railway | Railway | Railway MySQL | $5〜$20 |
| **Render** | Static Site | Web Service | PostgreSQL | 無料〜$25 |
| **AWS** | CloudFront+S3 | ECS/Lambda | RDS | $30〜$100 |

**推奨**: Vercel + PlanetScale（スケーラビリティ、DXの良さ）

#### 3.2 データベース本番化
- [ ] PlanetScale/Neon/Supabaseアカウント作成
- [ ] 本番DBスキーマ適用
- [ ] マイグレーション戦略確立
  ```bash
  npx drizzle-kit push:mysql --config=drizzle.config.ts
  ```
- [ ] 接続プーリング設定

#### 3.3 バックアップ戦略
- [ ] 自動バックアップ設定（日次）
- [ ] ポイントインタイムリカバリ有効化
- [ ] バックアップ復元手順書作成
- [ ] 災害復旧計画（RTO: 4時間、RPO: 1時間）

#### 3.4 ステージング環境
- [ ] ステージング環境構築
- [ ] プレビューデプロイ設定（PR毎）
- [ ] 環境変数の分離

**成果物**:
- `docs/DEPLOYMENT.md` - デプロイガイド
- `docs/BACKUP_STRATEGY.md` - バックアップ手順
- ステージング環境URL

---

### Phase 4: 監視・ログ・アラート（優先度: 高）
**目的**: 本番環境の可視化と障害対応

#### 4.1 エラー監視（Sentry強化）
- [ ] Sentry DSN本番用設定
- [ ] ソースマップアップロード設定
- [ ] アラートルール設定
  - エラー率 > 1% → Slack通知
  - 新規エラー → メール通知
- [ ] リリースバージョン追跡

#### 4.2 アップタイム監視
- [ ] UptimeRobot/Better Uptime設定
- [ ] 監視対象エンドポイント
  - `https://helix.example.com/` - トップページ
  - `https://helix.example.com/api/health` - ヘルスチェック
- [ ] ダウンタイムアラート（Slack/メール）

#### 4.3 アプリケーションログ
- [ ] 集中ログ管理選定
  - **推奨**: Axiom（無料枠あり、使いやすい）
  - 代替: Logtail, Papertrail, CloudWatch Logs
- [ ] ログフォーマット統一（JSON構造化ログ）
- [ ] ログ保持期間設定（30日推奨）

#### 4.4 パフォーマンス監視
- [ ] Web Vitals監視
  - LCP < 2.5s
  - FID < 100ms
  - CLS < 0.1
- [ ] ページロード時間追跡
- [ ] APIレスポンス時間追跡

**成果物**:
- Sentryプロジェクト設定
- 監視ダッシュボード
- アラートルール一覧
- `docs/MONITORING.md` - 監視運用ガイド

---

### Phase 5: ドキュメント整備（優先度: 中）
**目的**: 運用・保守の効率化

#### 5.1 技術ドキュメント
- [ ] `docs/ARCHITECTURE.md` - アーキテクチャ概要
- [ ] `docs/API.md` - APIリファレンス
- [ ] `docs/DATABASE.md` - DBスキーマ説明
- [ ] `docs/DEPLOYMENT.md` - デプロイ手順

#### 5.2 運用ドキュメント
- [ ] `docs/RUNBOOK.md` - 障害対応手順
- [ ] `docs/BACKUP_STRATEGY.md` - バックアップ/復元手順
- [ ] `docs/MONITORING.md` - 監視運用ガイド
- [ ] `docs/SECURITY.md` - セキュリティポリシー

#### 5.3 開発者ドキュメント
- [ ] `CONTRIBUTING.md` - コントリビューションガイド
- [ ] `README.md` 更新 - セットアップ手順完備
- [ ] コンポーネントStorybook（オプション）

**成果物**:
- `docs/` ディレクトリ配下のMarkdownファイル群

---

### Phase 6: 法務・コンプライアンス（優先度: 中）
**目的**: 法的リスクの軽減

#### 6.1 利用規約・プライバシーポリシー
- [ ] 利用規約（Terms of Service）
  - サービス内容の説明
  - 免責事項（医療アドバイスではない旨）
  - 禁止事項
  - 知的財産権
- [ ] プライバシーポリシー
  - 収集する個人情報
  - Cookie使用について
  - 第三者サービス（GA4, Sentry）への情報提供
  - データ保持期間
  - 連絡先

#### 6.2 Cookie同意（GDPR対応）
- [ ] 現状のCookie同意UIの確認
- [ ] 必須/オプショナルCookieの分類
- [ ] 同意撤回機能の確認

#### 6.3 医療情報の免責
- [ ] 免責表示の目立つ配置
- [ ] 「医療アドバイスではありません」の明記
- [ ] プロンプト使用上の注意喚起

**成果物**:
- `/legal` ページの完成
- 利用規約文書
- プライバシーポリシー文書

---

### Phase 7: パフォーマンス最適化（優先度: 中）
**目的**: ユーザー体験の向上

#### 7.1 画像最適化
- [ ] WebP/AVIF形式への変換
- [ ] 適切なサイズの画像生成
- [ ] lazy loading確認
- [ ] CDN経由での配信

#### 7.2 キャッシュ戦略
- [ ] 静的アセットのCache-Control設定
- [ ] API応答のキャッシュ検討
- [ ] Service Worker有効化（PWA）

#### 7.3 バンドルサイズ最適化
- [ ] 未使用依存関係の削除
- [ ] Tree shakingの確認
- [ ] 動的インポートの最適化

**成果物**:
- Lighthouseスコア 90以上
- Core Web Vitals合格

---

### Phase 8: リリース準備（優先度: 高）
**目的**: スムーズなローンチ

#### 8.1 プレローンチチェックリスト
- [ ] 全テストパス確認
- [ ] セキュリティスキャン実施
- [ ] パフォーマンステスト実施
- [ ] 負荷テスト実施（k6/Artillery）
- [ ] アクセシビリティ監査
- [ ] SEO監査（Google Search Console連携）
- [ ] 法務レビュー完了

#### 8.2 ドメイン・DNS設定
- [ ] ドメイン取得（例: helix-medical.jp）
- [ ] SSL証明書設定
- [ ] DNS設定
- [ ] リダイレクト設定（www→non-www等）

#### 8.3 ローンチ当日
- [ ] 本番デプロイ
- [ ] DNSカットオーバー
- [ ] 監視ダッシュボード確認
- [ ] Smoke test実施
- [ ] 初期ユーザーモニタリング

#### 8.4 ポストローンチ
- [ ] エラーレート監視（24時間）
- [ ] パフォーマンス監視
- [ ] ユーザーフィードバック収集
- [ ] ホットフィックス体制確認

**成果物**:
- プレローンチチェックリスト完了
- ローンチ当日手順書
- ロールバック手順書

---

## 📊 優先順位サマリー

| Phase | 名称 | 優先度 | 依存関係 |
|-------|------|--------|---------|
| 1 | テスト強化 | 🔴 最高 | なし |
| 2 | セキュリティ強化 | 🔴 最高 | なし |
| 3 | インフラ構築 | 🟠 高 | なし |
| 4 | 監視・ログ | 🟠 高 | Phase 3 |
| 5 | ドキュメント | 🟡 中 | なし |
| 6 | 法務・コンプライアンス | 🟡 中 | なし |
| 7 | パフォーマンス最適化 | 🟡 中 | Phase 3 |
| 8 | リリース準備 | 🟠 高 | Phase 1-7 |

---

## ⚠️ リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|---------|------|
| テストカバレッジ不足でのリリース | 高 | 中 | Phase 1を最優先、80%未達ならリリース延期 |
| セキュリティ脆弱性 | 高 | 低 | Phase 2でCSP強化、定期的なセキュリティスキャン |
| DBダウンタイム | 高 | 低 | マネージドDB使用、自動バックアップ、HA構成 |
| 急激なトラフィック増加 | 中 | 中 | オートスケーリング設定、CDN活用 |
| 法的問題（医療免責） | 高 | 低 | 弁護士レビュー、免責表示の徹底 |

---

## 🎯 成功基準

### 技術指標
- [ ] テストカバレッジ 80%以上
- [ ] Lighthouseスコア 90以上（全カテゴリ）
- [ ] Core Web Vitals 全項目合格
- [ ] エラーレート < 0.1%
- [ ] 99.9% アップタイム

### ビジネス指標（参考）
- [ ] 初月アクティブユーザー数
- [ ] プロンプトコピー率
- [ ] 平均セッション時間
- [ ] ユーザー満足度

---

## 📝 補足事項

### 将来的な拡張（スコープ外）
以下は本リリースのスコープ外だが、将来的に検討：
- 多言語対応（i18n）- 現在は日本語のみ
- ユーザー登録機能（現在はlocalStorage）
- 管理者ダッシュボード
- AIプロンプト自動生成機能
- コミュニティ機能（プロンプト共有）

### 参考リソース
- [Vercel デプロイガイド](https://vercel.com/docs)
- [PlanetScale ドキュメント](https://planetscale.com/docs)
- [Playwright E2Eテスト](https://playwright.dev/)
- [Web Vitals](https://web.dev/vitals/)

---

**最終更新**: 2026-01-26
**プラン作成者**: Claude Code
